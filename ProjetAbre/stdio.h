/* Sorry for the very cryptic file. It is cryptic not because I want it to  */
/* be cryptic, but because it must be written in such manner. I have very   */
/* strong reasons for usage of (very awkward) casting arrays to functions.  */
/* Namely, such definitions allow that a function which is not called in    */
/* the program will not be included in the program, and a function which is */
/* called more than once will be included just once. The first property     */
/* would not be true if a function is implemented as a "normal" function in */
/* the header file, and the second property would not be true if a function */
/* is implemented as a smart inline macro. In "normal" C compilers, such    */
/* problems are solved using an external library of object files which      */
/* contain implementations of all functions, and they would be linked with  */
/* the program when necessary. But note that TI-GCC linker does not support */
/* external libraries of object files, so for a while, such "cryptic"       */
/* definitions are the only solution! True sources of all routines are      */
/* presented in a file named "SOURCES".                                     */

#ifndef __STDIO
#define __STDIO

#ifndef NOSTUB
#ifndef DOORS
#ifndef USE_KERNEL
#include <nostub.h>
#else
#include <doors.h>
#endif
#endif
#endif

#undef NULL
#undef size_t
#define NULL ((void*)0)
#define size_t unsigned long

#ifndef __VA_LIST
#define __VA_LIST

typedef void *va_list;

#endif

#ifndef __SPRINTF
#define __SPRINTF

#define sprintf _rom_call(short,(char*,char*,...),53)
#define strerror _rom_call(char*,(short),27D)

#ifdef DOORS

short sprintf(char*,char*,...);
char *strerror(short);

#endif

#endif

#define printf_xy(x,y,f...) \
  ({char __s[200]; _rom_call(short,(char*,char*,...),53)(__s ,##f); \
  _rom_call(void,(short,short,char*,short),1A9)(x,y,__s,4);})

#define EOF (-1)

enum FileFlags {_F_READ=0x0001,_F_WRIT=0x0002,_F_RDWR=0x0003,_F_ERR=0x0010,
  _F_EOF=0x0020,_F_BIN=0x0040};

enum SeekModes {SEEK_SET,SEEK_CUR,SEEK_END};

typedef struct
  {
    char *fpos;
    void *base;
    unsigned short handle;
    short flags;
    short unget;
    unsigned long alloc;
  } FILE;

typedef unsigned long fpos_t;

#define vcbprintf ({register long __a=32+*(long*)(*(long*)0xC8+0x14C); \
  (void(*)(void(*)(char,void**),void**,char*,void*))(__a+*(short*)__a);})

#define vprintf(f,a) \
  vcbprintf((void(*)(char,void**))fputchar,NULL,(f),(a))
#define vfprintf(s,f,a) \
  vcbprintf((void(*)(char,void**))fputc,(void**)(s),(f),(a))
#define vsprintf(b,f,a) ((void)({void *__p=(b); \
  vcbprintf((void(*)(char,void**))strputchar,&__p,(f),(a)); *(char*)__p=0;}))

#define fputchar ((short(*)(char))(short[]){0x4E56,-20,0x48E7,0x1F3C,0x4240, \
  0x1C2E,9,0x2A78,0xC8,0x206D,0x638,0x4E90,0x3800,0xE34C,0x5C44,0x266D,0xBC, \
  0x486E,-18,0x206D,0x680,0x4E90,0x3A2E,-8,0x362E,-6,0x3F06,0x206D,0x640, \
  0x4E90,0x3E00,0xC06,10,0x670E,0x3005,0xD047,0x4241,0x122B,2,0xB240,0x6C04, \
  0x4245,0xD644,0x3003,0xD044,0x4241,0x122B,3,0xB240,0x6C10,0x4257,0x3F04, \
  0x2F0B,0x2F0B,0x206D,0x62C,0x4E90,0x9644,0x3EBC,4,0x3F06,0x3F03,0x3F05, \
  0xC06,10,0x6708,0x206D,0x690,0x4E90,0xDF57,0x206D,0x674,0x4E90,0x3006, \
  0x4CEE,0x3CF8,-56,0x4E5E,0x4E75})

#define strputchar ((void(*)(char,void**))(short[]){0x226F,6,0x2051,0x10AF,5, \
  0x5291,0x4E75})

#define puts(s) (((void(*)(void*,char*))((short[]){0x2F48,8,0x3F00,0x206F,6, \
  0x4E90,0x548F,0x206F,8,0x1018,0x66EA,0x4E75}+7))(fputchar,s))

#define printf(f...) (((void(*)(void*,char*,...))(short[]){0x2078,0xC8,0x2068, \
  0x14C,0x41E8,32,0x3250,0x486F,12,0x2F2F,12,0x42A7,0x2F2F,16,0x4EB1,0x8800, \
  0x4FEF,16,0x4E75})(fputchar ,##f))

#define fprintf(s,f...) (((void(*)(void*,FILE*,char*,...))(long[]) \
  {0x207800C8,0x2068014C,0x41E80020,0x3250486F,0x102F2F,0x102F2F,0x102F2F, \
  0x104EB1,0x88004FEF,0x104E75})(fputc,s ,##f))

#define clrscr ((void(*)(void))(long[]){0x207800C8,0x20680674,0x42A74E90, \
  0x588F2078,0xC82068,0x6784ED0})

#define fopen ((FILE*(*)(char*,char*))(short[]){0x4E56,0xFFBC,0x48E7,0x1F3C, \
  0x246E,8,0x49EE,0xFFCE,0x226E,12,0x1C11,0x4247,0xC29,0x62,1,0x6708,0xC29, \
  0x62,2,0x6602,0x7E01,0x2078,0xC8,0x4878,18,0x2068,0x288,0x4E90,0x2A48, \
  0x588F,0xBAFC,0,0x6606,0x91C8,0x6000,0x182,0x421C,0x6002,0x528C,0x101A, \
  0x1880,0x66F8,0xC06,0x72,0x6706,0xC06,0x61,0x665A,0x7A01,0x2478,0xC8, \
  0x2F0C,0x206A,0x180,0x4E90,0x2F00,0x206A,0x1E4,0x4E90,0x2448,0x508F, \
  0xB4FC,0,0x660C,0xC06,0x72,0x6700,0xA8,0x7C77,0x602E,0x2078,0xC8,0x302A, \
  12,0x3B40,8,0x3F00,0x2068,0x264,0x4E90,0x2648,0x2078,0xC8,0x3F2D,8,0x2068, \
  0x278,0x4E90,0x426D,14,0x3B40,16,0x588F,0xC06,0x77,0x6600,0xAC,0x7A02, \
  0x367C,0xC8,0x2053,0x78BC,0xD88E,0x2F04,0x2068,0x680,0x4E90,0x2453,0x2F0C, \
  0x206A,0x170,0x4E90,0x2F00,0x206A,0x1E4,0x4E90,0x2448,0x4FEF,12,0xB4FC,0, \
  0x57C3,0x4883,0x4443,0x2053,0x2F04,0x2068,0x684,0x4E90,0x588F,0x4A43, \
  0x661A,0x2078,0xC8,0x4878,0x3E8,0x2068,0x240,0x4E90,0x3540,12,0x3B40,8, \
  0x588F,0x661E,0x2078,0xC8,0x2F0C,0x2068,0x178,0x4E90,0x2078,0xC8,0x2F0D, \
  0x2068,0x28C,0x4E90,0x91C8,0x6000,0x8A,0x2B7C,0,0x3E8,14,0x2078,0xC8, \
  0x3F00,0x2068,0x264,0x4E90,0x2648,0x4A47,0x6704,0x4253,0x600E,0x26BC,5,1, \
  0x277C,0x2000,0xE000,4,0x4280,0x3013,0xD08B,0x4A47,0x6702,0x5480,0xC06, \
  0x61,0x6606,0x7A02,0x2200,0x600C,0x220B,0x5A81,0x4A47,0x6704,0x220B, \
  0x5481,0xB280,0x6604,0x45,0x20,0x226E,12,0xC29,0x2B,1,0x6708,0xC29,0x2B,2, \
  0x6604,0x45,3,0x4A47,0x6704,0x45,0x40,0x3B45,10,0x2B4B,4,0x2A81,0x426D,12, \
  0x204D,0x4CEE,0x3CF8,0xFF98,0x4E5E,0x4E75})

#define fclose ((short(*)(FILE*))(short[]){0x4E56,0,0x48E7,0x1030,0x266E,8, \
  0xB6FC,0,0x6604,0x70FF,0x6026,0x82B,4,11,0x56C3,0x4883,0x347C,0xC8,0x2052, \
  0x3F2B,8,0x2068,0x27C,0x4E90,0x2052,0x2F0B,0x2068,0x28C,0x4E90,0x3003, \
  0x4CEE,0xC08,0xFFF4,0x4E5E,0x4E75})

#define ftell ((long(*)(FILE*))(short[]){0x4E56,0,0x206E,8,0x3428,10,0x802,4, \
  0x6704,0x70FF,0x6014,0x2210,0x92A8,4,0x2001,0x5B80,0x802,6,0x6704,0x2001, \
  0x5580,0x4E5E,0x4E75})

#define fseek ((long(*)(FILE*,long,short))(short[]){0x4E56,0,0x48E7,0x1E20, \
  0x246E,8,0x282E,12,0x3A2E,16,0x362A,10,0x3C03,0x3203,0x241,0x40,0x206A,4, \
  0x43E8,5,0x6704,0x43E8,2,0x4280,0x3010,0x2408,0xD480,0x4A41,0x6702,0x5482, \
  0x4A45,0x670C,0x2002,0xC45,1,0x6606,0x2012,0x6002,0x2009,0xD084,0x806,4, \
  0x6704,0x70FF,0x6034,0xB3C0,0x620A,0xB480,0x6506,0xC45,2,0x630C,0x46,16, \
  0x3546,10,0x70FF,0x601A,0x2480,0x426A,12,0xB480,0x6606,0x43,32,0x6004, \
  0x243,0xFFDF,0x3543,10,0x7000,0x4CDF,0x478,0x4E5E,0x4E75})

#define fputc ((short(*)(short,FILE*))(long[]){0x4E560000,0x48E71C30,0x382E0008, \
  0x266E000A,0x322B000A,0x3601EC4B,0xA430001,0x2430001,0x246B0004, \
  0x2A0A0801,0x46706,0x70FF6000,0xE20801,0x1660E,0x410010,0x3741000A, \
  0x70FF6000,0xCE3012,0x640000A,0x2800000,0xFFFFB0AB,0xE635C,0x347C00C8, \
  0x20523F2B,0x82068,0x27C4E90,0x2052202B,0xE0680,0x3E8,0x2740000E, \
  0x2F003F2B,0x82068,0x2744E90,0x508F4A40,0x660A006B,0x10000A,0x70FF607E, \
  0x207800C8,0x3F2B0008,0x20680264,0x4E902748,0x42448,0x200A9085,0xD193548F, \
  0x322B000A,0x8010005,0x67025252,0xC44000A,0x66064A43,0x6702780D, \
  0x20531084,0x52930C44,0xD660E,0x4A43670A,0x2F0B3F3C,0x204EBA,0xFF204280, \
  0x3012D08A,0x22134A43,0x66085480,0xB2806706,0x601AB280,0x6616006B, \
  0x20000A,0x4A43670C,0x20534210,0x2053117C,0xFFE00001,0x30044CEE,0xC38FFEC, \
  0x4E5E4E75})

#define fgetc ((short(*)(FILE*))(long[]){0x4E560000,0x48E71820,0x246E0008, \
  0x302A000A,0x3600EC4B,0x0A430001,0x2430001,0x8000004,0x660E0800,0x660C, \
  0x400010,0x3540000A,0x70FF6052,0x382A000C,0x6C0A426A,0xC4240,0x10046042, \
  0x8000005,0x66E62052,0x42441810,0x52920C44,0xD660A,0x4A436706,0x2F0A4EBA, \
  0xFFA0206A,0x44280,0x3010D088,0x22124A43,0x66085480,0xB2806706,0x600AB280, \
  0x6606006A,0x20000A,0x30044CEE,0x418FFF4,0x4E5E4E75})

#define fputs(s,f) (((short(*)(void*,char*,FILE*))((short[]){0x2F48,8,0x2F2F,12, \
  0x3F01,0x206F,10,0x4E90,0x5C8F,0x206F,8,0x4241,0x1218,0x66E4,0x4E75}+9)) \
  (fputc,s,f))

#define fgets(s,n,f) (((char*(*)(void*,char*,short,FILE*))(long[]){0x4E560000, \
  0x48E71838,0x286E0008,0x282E000C,0x266E0012,0x2444362E,0x106024, \
  0x2F0B4E94,0x588F0C40,0xFFFF671E,0xC40000D,0x660A082B,0x6000B,0x6602700A, \
  0x14C00C00,0xA6706,0x53434A43,0x6ED64212,0xC40FFFF,0x6604B88A,0x67042004, \
  0x60027000,0x20404CEE,0x1C18FFEC,0x4E5E4E75})(fgetc,s,n,f))

#define fwrite(p,s,n,f) (((unsigned short(*)(short(*)(short,FILE*),void*,short,short, \
  FILE*))(short[]){0x4E56,0,0x48E7,0x1F3C,0x286E,8,0x246E,12,0x3C2E,16,0x3E2E, \
  18,0x266E,20,0x3A6B,10,0x320D,0x41,0x40,0x3741,10,0x4245,0xBE45,0x6322, \
  0x4244,0xBC44,0x6316,0x4243,0x2F0B,0x161A,0x3F03,0x4E94,0x5C8F,0x4A40, \
  0x6D0C,0x5244,0xBC44,0x62EC,0x5245,0xBE45,0x62DE,0x374D,10,0x3005,0x4CEE, \
  0x3CF8,0xFFDC,0x4E5E,0x4E75})(fputc,p,s,n,f))

#define fread(p,s,n,f) (((unsigned short(*)(short(*)(FILE*),void*,short,short,FILE*)) \
  (short[]){0x4E56,0,0x48E7,0x1F38,0x286E,8,0x246E,12,0x3A2E,16,0x3C2E,18, \
  0x266E,20,0x3E2B,10,0x3207,0x41,0x40,0x3741,10,0x4244,0xBC44,0x631E, \
  0x4243,0xBA43,0x6312,0x2F0B,0x4E94,0x588F,0x4A40,0x6D0E,0x14C0,0x5243, \
  0xBA43,0x62EE,0x5244,0xBC44,0x62E2,0x3747,10,0x3004,0x4CEE,0x1CF8,0xFFE0, \
  0x4E5E,0x4E75})(fgetc,p,s,n,f))

#define rename ((short(*)(char*,char*))(long[]){0x4E56FF9C,0x2F0B2F0A, \
  0x206E0008,0x266E000C,0x422EFF9C,0x45EEFF9D,0x6002528A,0x10181480, \
  0x66F843EA,0x16002,0x5289101B,0x128066F8,0x207800C8,0x2F092F0A,0x2068018C, \
  0x4E905340,0x246EFF94,0x266EFF98,0x4E5E4E75})

#define unlink ((short(*)(char*))(long[]){0x4E56FFCC,0x206E0008,0x422EFFCE, \
  0x43EEFFCF,0x60025289,0x10181280,0x66F82078,0xC82F09,0x20680178, \
  0x4E905340,0x4E5E4E75})

#define fgetchar() ({register short __c=_rom_call(short,(),51)(); \
  fputchar((__c=='\r')?'\n':__c);})

#define gets(s) ({register short __c; register char *__p=s; \
  while((*__p++=fputchar(((__c=_rom_call(short,(),51)())=='\r')?'\n':__c)) \
  !='\n'); __p[-1]=0; s; })

#define getchar() fgetchar()
#define putchar(c) fputchar(c)
#define getc(f) fgetc(f)
#define putc(c,f) fputc((c),(f))

#define feof(f) (((f)->flags)&_F_EOF)
#define ferror(f) (((f)->flags)&_F_ERR)
#define clearerr(f) ((void)(((f)->flags)&=~(_F_EOF|_F_ERR)))

#define freopen(n,m,f) (fclose(f),(f)=fopen((n),(m)))

#define fgetpos(f,p) ((*(p)=ftell(f))==EOF)
#define fsetpos(f,p) fseek((f),*(p),SEEK_SET)

#define rewind(f) ((void)(fseek((f),0,SEEK_SET),(f)->flags&=~_F_ERR))

#define ungetc(c,f) ((f)->unget=((c)|0x8000))
#define fflush(f) ((f)->unget=0)

#define remove(f) unlink(f)

#endif
